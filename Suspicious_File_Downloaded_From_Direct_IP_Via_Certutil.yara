rule Suspicious_File_Downloaded_From_Direct_IP_Via_Certutil {
    meta:
        description = "Detects execution of Certutil with flags for suspicious file download from direct IPs"
        author = "Nasreddine Bencherchali (Nextron Systems)"
        date = "2023/02/15"
        reference = " https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil"
    strings:
        $certutil_executable = /\\CertUtil\.exe$/i
        $download_flags = /urlcache\s+|verifyctl\s+/i
        $direct_ip_prefixes = /:\/\/[1-9]/i
        $exclude_local_ips = /:\/\/(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[0-1])\.|127\.|169\.254\.)/i
        $exclude_7_zip = /:\/\/7-/i
    condition:
        $certutil_executable and $download_flags and $direct_ip_prefixes and not ($exclude_local_ips or $exclude_7_zip)
}
