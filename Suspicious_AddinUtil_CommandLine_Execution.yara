rule Suspicious_AddinUtil_CommandLine_Execution
{
    meta:
        description = "Detects execution of Add-In deployment cache updating utility (AddInUtil.exe) with suspicious Addinroot or Pipelineroot paths"
        id = "631b22a4-70f4-4e2f-9ea8-42f84d9df6d8"
        status = "experimental"
        references = "https://www.blue-prints.blog/content/blog/posts/lolbin/addinutil-lolbas.html"
        author = "Nasreddine Bencherchali (Nextron Systems), Michael McKinley (@McKinleyMike), Tony Latteri (@TheLatteri)"
        date = "2023/09/18"
        tags = "attack.defense_evasion, attack.t1218"
        level = "high"
    
    strings:
        $img_endswith_addinutil = "addinutil.exe"
        $filename = "AddInUtil.exe"
        $cmd_contains_addinroot = "-AddInRoot:"
        $cmd_contains_pipelineroot = "-PipelineRoot:"
        $cmd_contains_suspicious_paths_1 = "\\AppData\\Local\\Temp\\"
        $cmd_contains_suspicious_paths_2 = "\\Desktop\\"
        $cmd_contains_suspicious_paths_3 = "\\Downloads\\"
        $cmd_contains_suspicious_paths_4 = "\\Users\\Public\\"
        $cmd_contains_suspicious_paths_5 = "\\Windows\\Temp\\"

    condition:
        ($img_endswith_addinutil or $filename) and
        (
            ($cmd_contains_addinroot or $cmd_contains_pipelineroot) or
            (
                (
                    $cmd_contains_suspicious_paths_1 or
                    $cmd_contains_suspicious_paths_2 or
                    $cmd_contains_suspicious_paths_3 or
                    $cmd_contains_suspicious_paths_4 or
                    $cmd_contains_suspicious_paths_5
                ) and
                (
                    ("-AddInRoot:." or "-AddInRoot:\".\"") or
                    ("-PipelineRoot:." or "-PipelineRoot:\".\"")
                )
            )
        )
}
