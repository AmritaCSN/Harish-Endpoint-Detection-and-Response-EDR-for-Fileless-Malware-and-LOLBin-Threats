rule Suspicious_XOR_Encoded_PowerShell_Command {
    meta:
        description = "Detects presence of a potentially xor encoded powershell command"
        author = "Sami Ruohonen, Harish Segar, Tim Shelton, Teymur Kheirkhabarov, Vasiliy Burov, oscd.community, Nasreddine Bencherchali"
        date = "2018/09/05"
        modified = "2023/01/30"
        references = "https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse?slide=65"
        tags = "attack.defense_evasion, attack.execution, attack.t1059.001, attack.t1140, attack.t1027"
        level = "medium"

    strings:
        $xorEncodedPowerShell = /bxor/i
        $otherSuspiciousStrings = /ForEach|for\(|for |\-join |-join'|\-join"|-join`|::Join|\[char\]/

    condition:
        (any of them) and (1 of ($xorEncodedPowerShell, $otherSuspiciousStrings))
}
