import "pe"

rule Uncommon_Child_Process_Of_AddinUtil_EXE
{
    meta:
        description = "Detects uncommon child processes of Add-In deployment cache updating utility (AddInutil.exe)"
        id = "b5746143-59d6-4603-8d06-acbd60e166ee"
        status = "experimental"
        references = "https://www.blue-prints.blog/content/blog/posts/lolbin/addinutil-lolbas.html"
        author = "Michael McKinley (@McKinleyMike), Tony Latteri (@TheLatteri)"
        date = "2023/09/18"
        tags = "attack.defense_evasion, attack.t1218"
        level = "medium"
    
    strings:
        $parent_endswith_addinutil = "\\addinutil.exe"
        $filename_1 = "conhost.exe"
        $filename_2 = "werfault.exe"
        $directory_1= "\\Windows\\System32\\"
        $directory_2 = "\\Windows\\SysWOW64\\"
    condition:
        $parent_endswith_addinutil and not (
            // Check for conhost.exe or werfault.exe in System32 or SysWOW64
            ($filename_1 or $filename_2) and
            ($directory_1 or $directory_2)
        )
}