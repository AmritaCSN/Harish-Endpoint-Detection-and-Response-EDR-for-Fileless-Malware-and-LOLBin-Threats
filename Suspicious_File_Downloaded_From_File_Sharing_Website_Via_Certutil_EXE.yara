rule Suspicious_File_Downloaded_From_File_Sharing_Website_Via_Certutil_EXE {
    meta:
        description = "Detects the execution of certutil with certain flags that allow the utility to download files from file-sharing websites."
        author = "Nasreddine Bencherchali (Nextron Systems)"
        date = "2023/02/15"
        modified = "2024/02/09"
        reference = "https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil"
        reference = "https://forensicitguy.github.io/agenttesla-vba-certutil-download/"
        reference = "https://news.sophos.com/en-us/2021/04/13/compromised-exchange-server-hosting-cryptojacker-targeting-other-exchange-servers/"
        reference = "https://twitter.com/egre55/status/1087685529016193025"
        reference = "https://lolbas-project.github.io/lolbas/Binaries/Certutil/"
        reference = "https://www.microsoft.com/en-us/security/blog/2024/01/17/new-ttps-observed-in-mint-sandstorm-campaign-targeting-high-profile-individuals-at-universities-and-research-orgs/"
        status = "experimental"
        tags = "attack.defense_evasion, attack.t1027, level.high"
    strings:
        $certutilPath = "\\certutil.exe"
        $urlcacheFlag = "urlcache "
        $verifyctlFlag = "verifyctl "
        $fileSharingSites = ".githubusercontent.com anonfiles.com cdn.discordapp.com cdn.discordapp.com/attachments/ ddns.net dl.dropboxusercontent.com ghostbin.co glitch.me gofile.io hastebin.com mediafire.com mega.nz onrender.com paste.ee pastebin.com pastebin.pl pastetext.net privatlab.com privatlab.net send.exploit.in sendspace.com storage.googleapis.com storjshare.io supabase.co temp.sh transfer.sh ufile.io"
    condition:
        all of them
}
