rule Suspicious_Driver_Install_by_Pnputil {
    meta:
        description = "Detects when a possible suspicious driver is being installed via pnputil.exe lolbin"
        reference = "https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/pnputil-command-syntax"
        reference = "https://strontic.github.io/xcyclopedia/library/pnputil.exe-60EDC5E6BDBAEE441F2E3AEACD0340D2.html"
        author = "Hai Vaknin, Avihay Eldad, Austin Songer"
        date = "2021/09/30"
        modified = "2022/10/09"
        level = "medium"
    strings:
        $pnputil = "pnputil.exe" nocase
    condition:
        $pnputil at 0 and
        (
            // Check if pnputil.exe command line contains the specified parameters
            uint8(5) == 0x20 and uint8(6) == 0x2D and uint8(7) == 0x69 and uint8(8) == 0x20 or
            uint8(5) == 0x20 and uint8(6) == 0x2F and uint8(7) == 0x69 and uint8(8) == 0x20 or
            uint8(5) == 0x20 and uint8(6) == 0x2D and uint8(7) == 0x61 and uint8(8) == 0x20 or
            uint8(5) == 0x20 and uint8(6) == 0x2F and uint8(7) == 0x61 and uint8(8) == 0x20 or
            // Check for the presence of '.inf' in the command line
            for any i in (0..1024) : (
                (uint8(i) == 0x20 and uint8(i + 1) == 0x2D and uint8(i + 2) == 0x69 and uint8(i + 3) == 0x20 and uint8(i + 4) == 0x2D and
                uint8(i + 5) == 0x61 and uint8(i + 6) == 0x20 and uint8(i + 7) == 0x2F and uint8(i + 8) == 0x69 and uint8(i + 9) == 0x20) or
                (uint8(i) == 0x2E and uint8(i + 1) == 0x69 and uint8(i + 2) == 0x6E and uint8(i + 3) == 0x66)
            )
        )
}
