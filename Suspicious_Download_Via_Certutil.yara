rule Suspicious_Download_Via_Certutil {
  meta:
    title = "Suspicious Download Via Certutil.EXE"
    id = "19b08b1c-861d-4e75-a1ef-ea0c1baf202b"
    status = "test"
    description = "Detects the execution of certutil with certain flags that allow the utility to download files."
    references = "https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil, https://forensicitguy.github.io/agenttesla-vba-certutil-download/, https://news.sophos.com/en-us/2021/04/13/compromised-exchange-server-hosting-cryptojacker-targeting-other-exchange-servers/, https://twitter.com/egre55/status/1087685529016193025, https://lolbas-project.github.io/lolbas/Binaries/Certutil/"
    author = "Florian Roth (Nextron Systems), Jonhnathan Ribeiro, oscd.community, Nasreddine Bencherchali (Nextron Systems)"
    date = "2023/02/15"
    tags = "attack.defense_evasion, attack.t1027"
  strings:
    $certutil = "*\\certutil.exe" wide ascii  
    $urlcacheFlag = "urlcache " wide ascii
    $verifyctlFlag = "verifyctl " wide ascii
    $httpFlag = "http" wide ascii
  condition:
    all of them 
}
