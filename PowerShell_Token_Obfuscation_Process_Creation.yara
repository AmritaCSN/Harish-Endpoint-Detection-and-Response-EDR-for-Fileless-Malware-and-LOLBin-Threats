rule PowerShell_Token_Obfuscation_Process_Creation {
    meta:
        description = "Detects TOKEN OBFUSCATION technique from Invoke-Obfuscation in process creation"
        author = "frack113"
        date = "2022/12/27"
        modified = "2022/12/30"
        references = "https://github.com/danielbohannon/Invoke-Obfuscation"
        tags = "attack.defense_evasion, attack.t1027.009"
        level = "high"

    strings:
        $tokenObfuscation1 = /(\w+`(\w+|-|.)`[\w+|\s])/
        $tokenObfuscation2 = /"(\{\d\})+"\s*-f/
        $tokenObfuscation3 = /\$\{((e|n|v)*`(e|n|v)*)+:path\}|\$\{((e|n|v)*`(e|n|v)*)+:((p|a|t|h)*`(p|a|t|h)*)+\}|\$\{env:((p|a|t|h)*`(p|a|t|h)*)+\}/

    condition:
        1 of ($tokenObfuscation*)
}
