rule Use_of_SFTP_EXE {
    meta:
        description = "Detects the usage of the sftp.exe binary as a LOLBIN by abusing the -D flag"
        reference = "https://github.com/LOLBAS-Project/LOLBAS/pull/264"
        author = "Nasreddine Bencherchali (Nextron Systems)"
        date = "2022/11/10"
        level = "medium"
    strings:
        $sftp_exe = "sftp.exe" nocase
    condition:
        $sftp_exe at 0 and (
            (
                // Check if "-D" is followed by ".." or "C:\"
                uint8(1) == 0x20 and (uint8(3) == 0x2D and uint8(4) == 0x44) and (uint8(6) == 0x2E or uint8(6) == 0x43)
            ) or (
                // Check if "-D" is followed by a space
                uint8(1) == 0x20 and (uint8(3) == 0x2D and uint8(4) == 0x44) and uint8(6) == 0x20
            )
        )
}

// Additional condition to check if the file is a PE (Portable Executable)
rule Is_PE_File {
    condition:
        uint16(0) == 0x5A4D // Check if it's a valid PE file (MZ header)
}
