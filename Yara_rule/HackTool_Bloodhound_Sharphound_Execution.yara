rule HackTool_Bloodhound_Sharphound_Execution {
    meta:
        description = "Detects command line parameters used by Bloodhound and Sharphound hack tools"
        author = "Florian Roth (Nextron Systems)"
        date = "2019/12/20"
        modified = "2023/02/04"
        status = "test"
        tags = "attack.discovery, attack.t1087.001, attack.t1087.002, attack.t1482, attack.t1069.001, attack.t1069.002, attack.execution, attack.t1059.001, level.high"
        references = "https://github.com/BloodHoundAD/BloodHound, https://github.com/BloodHoundAD/SharpHound"
    strings:
        $bloodhound_names = "Bloodhound.exe" wide
        $sharphound_names = "SharpHound.exe" wide
        $sharp_methods_1 = " -CollectionMethod All " wide
        $sharp_methods_2 = " --CollectionMethods Session " wide
        $sharp_methods_3 = " --Loop --Loopduration " wide
        $sharp_methods_4 = " --PortScanTimeout " wide
        $sharp_methods_5 = ".exe -c All -d " wide
        $sharp_methods_6 = "Invoke-Bloodhound" wide
        $sharp_methods_7 = "Get-BloodHoundData" wide
        $sharp_methods_8 = " -JsonFolder " wide
        $sharp_methods_9 = " -ZipFileName " wide
        $sharp_methods_10 = " DCOnly " wide
        $sharp_methods_11 = " --NoSaveCache " wide
    condition:
        ($bloodhound_names at 1 or $sharphound_names at 1) and
        (
            $sharp_methods_1 at 2 or
            $sharp_methods_2 at 2 or
            $sharp_methods_3 at 2 or
            $sharp_methods_4 at 2 or
            $sharp_methods_5 at 2 or
            $sharp_methods_6 at 2 or
            $sharp_methods_7 at 2 or
            ($sharp_methods_8 at 2 and $sharp_methods_9 at 2) or
            $sharp_methods_10 at 2 or
            $sharp_methods_11 at 2
        )
}
