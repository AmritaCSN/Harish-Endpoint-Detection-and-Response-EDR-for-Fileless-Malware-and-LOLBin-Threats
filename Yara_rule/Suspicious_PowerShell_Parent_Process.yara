rule Suspicious_PowerShell_Parent_Process {
    meta:
        description = "Detects a suspicious or uncommon parent processes of PowerShell"
        author = "Teymur Kheirkhabarov, Harish Segar"
        date = "2020/03/20"
        modified = "2023/02/04"
        references = "https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse?slide=26"
        tags = "attack.execution, attack.t1059.001"
        level = "high"

    strings:
        $powershellProcesses = /\b(powershell\.exe|pwsh\.exe)\b/i
        $suspiciousParentProcesses = /\b(tomcat|amigo\.exe|browser\.exe|chrome\.exe|firefox\.exe|httpd\.exe|iexplore\.exe|jbosssvc\.exe|microsoftedge\.exe|microsoftedgecp\.exe|MicrosoftEdgeSH\.exe|mshta\.exe|nginx\.exe|outlook\.exe|php-cgi\.exe|regsvr32\.exe|rundll32\.exe|safari\.exe|services\.exe|sqlagent\.exe|sqlserver\.exe|sqlservr\.exe|vivaldi\.exe|w3wp\.exe)\b/i

    condition:
        $suspiciousParentProcesses at 0 and $powershellProcesses at 0
}
