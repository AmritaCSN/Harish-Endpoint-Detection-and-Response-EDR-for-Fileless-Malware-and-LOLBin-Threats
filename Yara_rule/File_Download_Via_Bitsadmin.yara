import "pe"

rule FileDownloadViaBitsadmin {
    meta:
        title = "File Download Via Bitsadmin"
        id = "d059842b-6b9d-4ed1-b5c3-5b89143c6ede"
        status = "test"
        description = "Detects usage of bitsadmin downloading a file"
        references = "https://blog.netspi.com/15-ways-to-download-a-file/#bitsadmin, https://isc.sans.edu/diary/22264, https://lolbas-project.github.io/lolbas/Binaries/Bitsadmin/"
        author = "Michael Haag, FPT.EagleEye"
        date = "2017/03/09"
        tags = "attack.defense_evasion, attack.persistence, attack.t1197, attack.s0190, attack.t1036.003"
    strings:
        $bitsadminImage = "*\\bitsadmin.exe" wide
        $bitsadminOriginalFileName = "bitsadmin.exe" wide
        $transferCmd = "/transfer " wide ascii
        $createCmd = "/create " wide ascii
        $addfileCmd = "/addfile " wide ascii
    condition:
        ($bitsadminOriginalFileName or $bitsadminImage) and (any of them)
}
