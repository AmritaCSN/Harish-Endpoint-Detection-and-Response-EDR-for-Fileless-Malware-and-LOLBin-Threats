rule Copying_Sensitive_Files_With_Credential_Data {
    meta:
        description = "Detects copying sensitive files with credential data using Esentutl"
        author = "Teymur Kheirkhabarov, Daniil Yugoslavskiy, oscd.community"
        date = "2019/10/22"
        modified = "2022/11/11"
        status = "test"
        tags = "attack.credential_access, attack.t1003.002, attack.t1003.003, car.2013-07-001, attack.s0404, level.high"
    strings:
        $esentutl_img = "esentutl.exe" wide
        $esentutl_cli_vss = "vss" wide ascii
        $esentutl_cli_m = " /m " wide ascii
        $esentutl_cli_y = " /y " wide ascii
        $susp_file_1 = "\\windows\\ntds\\ntds.dit" wide
        $susp_file_2 = "\\config\\sam" wide
        $susp_file_3 = "\\config\\security" wide
        $susp_file_4 = "\\config\\system " wide
        $susp_file_5 = "\\repair\\sam" wide
        $susp_file_6 = "\\repair\\system" wide
        $susp_file_7 = "\\repair\\security" wide
        $susp_file_8 = "\\config\\RegBack\\sam" wide
        $susp_file_9 = "\\config\\RegBack\\system" wide
        $susp_file_10 = "\\config\\RegBack\\security" wide
    condition:
        (
            (all of ($esentutl_img, $esentutl_cli_vss, $esentutl_cli_m, $esentutl_cli_y)) or
            1 of ($susp_file_*)
        )
}
