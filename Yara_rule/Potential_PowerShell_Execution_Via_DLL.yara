rule PotentialPowerShellExecutionViaDLL {
    meta:
        description = "Detects potential PowerShell execution from a DLL instead of the usual PowerShell process as seen used in PowerShdll"
        author = "Markus Neis, Nasreddine Bencherchali"
        date = "2018/08/25"
        reference = "https://github.com/p3nt4/PowerShdll/blob/62cfa172fb4e1f7f4ac00ca942685baeb88ff356/README.md"
        tags = "attack.defense_evasion, attack.t1218.011"
    strings:
        $dll_names = /rundll32\.exe|regsvcs\.exe|InstallUtil\.exe|regasm\.exe/ nocase
        $exe_names = /RUNDLL32\.EXE|RegSvcs\.exe|InstallUtil\.exe|RegAsm\.exe/ nocase
        $cmd_line_keywords = /Default\.GetString|FromBase64String|Invoke-Expression|IEX |Invoke-Command|ICM |DownloadString/ nocase
    condition:
        (all of ($dll_names, $exe_names) and any of them) and ($cmd_line_keywords)
}
