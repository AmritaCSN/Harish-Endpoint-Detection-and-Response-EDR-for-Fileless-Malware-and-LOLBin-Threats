rule PowerShellDefenderExclusion {
    meta:
        description = "Detects requests to exclude files, folders, or processes from Antivirus scanning using PowerShell cmdlets"
        author = "Florian Roth (Nextron Systems)"
        date = "2021/04/29"
        reference = "https://docs.microsoft.com/en-us/microsoft-365/security/defender-endpoint/configure-process-opened-file-exclusions-microsoft-defender-antivirus"
        tags = "attack.defense_evasion, attack.t1562.001"
    strings:
        $cmdlet1 = "Add-MpPreference " wide ascii nocase
        $cmdlet2 = "Set-MpPreference " wide ascii nocase
        $option1 = " -ExclusionPath " wide ascii nocase
        $option2 = " -ExclusionExtension " wide ascii nocase
        $option3 = " -ExclusionProcess " wide ascii nocase
        $option4 = " -ExclusionIpAddress " wide ascii nocase
    condition:
        any of ($cmdlet*, $option*) or
        all of ($cmdlet*, $option*)
}
