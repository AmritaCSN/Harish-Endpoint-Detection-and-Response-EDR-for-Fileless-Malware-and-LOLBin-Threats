rule Suspicious_Child_Process_Of_Veeam_Database {
    meta:
        description = "Detects suspicious child processes of the Veeam service process. This could indicate potential RCE or SQL Injection."
        author = "Nasreddine Bencherchali (Nextron Systems)"
        reference = "https://labs.withsecure.com/publications/fin7-target-veeam-servers"
        date = "2023/05/04"
        status = "experimental"
        tags = "attack.initial_access, attack.persistence, attack.privilege_escalation"
        level = "critical"
    strings:
        $parent_image = "*\\sqlservr.exe"
        $parent_command_line = "*VEEAMSQL*"
        $child_image_1 = "*\\cmd.exe"
        $child_image_2 = "*\\powershell.exe"
        $child_image_3 = "*\\pwsh.exe"
        $child_image_4 = "*\\wsl.exe"
        $child_image_5 = "*\\wt.exe"
        $child_command_line = "*-ex * or *bypass* or *cscript* or *DownloadString* or *http://* or *https://* or *mshta* or *regsvr32* or *rundll32* or *wscript* or *copy *"
        $child_image_net_1 = "*\\net.exe"
        $child_image_net_2 = "*\\net1.exe"
        $child_image_netstat = "*\\netstat.exe"
        $child_image_nltest = "*\\nltest.exe"
        $child_image_ping = "*\\ping.exe"
        $child_image_tasklist = "*\\tasklist.exe"
        $child_image_whoami = "*\\whoami.exe"
    condition:
        $parent_image and $parent_command_line and
        (
            $child_image_1 or $child_image_2 or $child_image_3 or $child_image_4 or $child_image_5 and $child_command_line or
            $child_image_net_1 or $child_image_net_2 or $child_image_netstat or $child_image_nltest or $child_image_ping or $child_image_tasklist or $child_image_whoami
        )
}
