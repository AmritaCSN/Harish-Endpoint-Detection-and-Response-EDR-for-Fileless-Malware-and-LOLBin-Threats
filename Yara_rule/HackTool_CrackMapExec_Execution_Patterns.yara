rule HackTool_CrackMapExec_Execution_Patterns {
    meta:
        description = "Detects various execution patterns of the CrackMapExec pentesting framework"
        author = "Thomas Patzke"
        date = "2020/05/22"
        modified = "2023/11/06"
        status = "stable"
        tags = "attack.execution, attack.t1047, attack.t1053, attack.t1059.003, attack.t1059.001, attack.s0106"
        references = "https://github.com/byt3bl33d3r/CrackMapExec"
    strings:
        $cmd_fileless_output_1 = "cmd.exe /Q /c * 1> \\\\*\\*\\* 2>&1" wide ascii
        $cmd_fileless_output_2 = "cmd.exe /C * > \\\\*\\*\\* 2>&1" wide ascii
        $cmd_fileless_output_3 = "cmd.exe /C * > *\\Temp\\* 2>&1" wide ascii
        $powershell_obfuscated = "powershell.exe -exec bypass -noni -nop -w 1 -C \"" wide ascii
        $powershell_non_obfuscated = "powershell.exe -noni -nop -w 1 -enc " wide ascii
    condition:
        any of them
}
