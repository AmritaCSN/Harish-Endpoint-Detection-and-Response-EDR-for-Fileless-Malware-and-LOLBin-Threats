rule File_In_Suspicious_Location_Encoded_To_Base64_Via_Certutil_EXE {
    meta:
        description = "Detects the execution of certutil with the 'encode' flag to encode a file to base64 where the files are located in potentially suspicious locations."
        author = "Nasreddine Bencherchali (Nextron Systems)"
        date = "2023/05/15"
        reference = "https://www.virustotal.com/gui/file/35c22725a92d5cb1016b09421c0a6cdbfd860fd4778b3313669b057d4a131cb7/behavior"
        reference = "https://www.virustotal.com/gui/file/427616528b7dbc4a6057ac89eb174a3a90f7abcf3f34e5a359b7a910d82f7a72/behavior"
        reference = "https://www.virustotal.com/gui/file/34de4c8beded481a4084a1fd77855c3e977e8ac643e5c5842d0f15f7f9b9086f/behavior"
        reference = "https://www.virustotal.com/gui/file/4abe1395a09fda06d897a9c4eb247278c1b6cddda5d126ce5b3f4f499e3b8fa2/behavior"
        status = "experimental"
        tags = "attack.defense_evasion, attack.t1027, level.high"
    strings:
        $certutilPath = "\\certutil.exe"
        $encodeFlag = "-encode"
        $slashEncodeFlag = "/encode"
        $suspiciousLocations = /(\AppData\Roaming\\|\Desktop\\|\Local\Temp\\|\PerfLogs\\|\Users\Public\\|\Windows\Temp\\|\$Recycle.Bin)/
    condition:
        all of them
}
