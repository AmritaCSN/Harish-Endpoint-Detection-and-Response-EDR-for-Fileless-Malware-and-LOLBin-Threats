rule Add_Windows_Capability_Via_PowerShell_Cmdlet {
    meta:
        description = "Detects usage of the Add-WindowsCapability cmdlet to add Windows capabilities, such as OpenSSH."
        author = "Nasreddine Bencherchali (Nextron Systems)"
        reference = "https://learn.microsoft.com/en-us/windows-server/administration/openssh/openssh_install_firstuse?tabs=powershell"
        date = "2023/01/22"
        modified = "2023/05/09"
        status = "experimental"
        tags = "attack.execution"
        level = "medium"
    strings:
        $powershellExe = "powershell.exe"
        $pwshExe = "pwsh.exe"
        $addWindowsCapabilityCmdlet = "Add-WindowsCapability"
        $openSSHCapability = "OpenSSH."
    condition:
         (
            ($powershellExe and $powershellExe at 0) or
            ($pwshExe and $pwshExe at 0)
        ) and
        $addWindowsCapabilityCmdlet at 0 and
        $openSSHCapability at 0
        
}
