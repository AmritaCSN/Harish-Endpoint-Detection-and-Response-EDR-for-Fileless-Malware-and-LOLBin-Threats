rule WindowsFirewallDisabledViaPowerShell {
    meta:
        description = "Detects attempts to disable the Windows Firewall using PowerShell"
        author = "Tim Rauch, Elastic (idea)"
        date = "2022/09/14"
        reference = "https://www.elastic.co/guide/en/security/current/windows-firewall-disabled-via-powershell.html"
        tags = "attack.defense_evasion, attack.t1562"
    strings:
        $powershell_binary1 = "powershell.exe" wide ascii nocase
        $powershell_binary2 = "pwsh.exe" wide ascii nocase
        $powershell_binary3 = "powershell_ise.exe" wide ascii nocase
        $powershell_binary4 = "PowerShell.EXE" wide ascii nocase
        $powershell_binary5 = "pwsh.dll" wide ascii nocase
        $command_line1 = "Set-NetFirewallProfile" wide ascii nocase
        $command_line2 = "-Enabled" wide ascii nocase
        $command_line3 = "False" wide ascii nocase
        $command_line4 = "-All" wide ascii nocase
        $command_line5 = "Public" wide ascii nocase
        $command_line6 = "Domain" wide ascii nocase
        $command_line7 = "Private" wide ascii nocase
    condition:
        any of ($powershell_binary*, $command_line*) and all of ($command_line*)
}
