rule HackTool_CrackMapExec_Process_Patterns {
    meta:
        description = "Detects suspicious process patterns found in logs when CrackMapExec is used"
        author = "Florian Roth (Nextron Systems)"
        date = "2022/03/12"
        modified = "2023/02/13"
        status = "test"
        tags = "attack.credential_access, attack.t1003.001"
        references = "https://mpgn.gitbook.io/crackmapexec/smb-protocol/obtaining-credentials/dump-lsass"
    strings:
        $lsass_dump_cmdline_1 = /tasklist \/fi.*Imagename eq lsass\.exe.*cmd\.exe \/[crk] .*(AUTHORI|AUTORI)/
        $lsass_dump_cmdline_2 = /do rundll32\.exe C:\\windows\\System32\\comsvcs\.dll, MiniDump.*\\Windows\\Temp\\.* full.*%%B/
        $procdump_cmdline = /tasklist \/v \/fo csv.*findstr \/i "lsass"/
    condition:
        any of them
}
