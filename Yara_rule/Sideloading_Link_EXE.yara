rule Sideloading_Link_EXE {
    meta:
        description = "Detects the execution of utilities often found in Visual Studio tools that hardcode the call to the binary link.exe"
        reference = "https://twitter.com/0gtweet/status/1560732860935729152"
        author = "Nasreddine Bencherchali (Nextron Systems)"
        date = "2022/08/22"
        level = "medium"
    strings:
        $link_exe = "link.exe" nocase
    condition:
        $link_exe at 0 and (
            // Check if link.exe is called with the hardcoded command line
            uint8(7) == 0x4C and uint8(8) == 0x49 and uint8(9) == 0x4E and uint8(10) == 0x4B and uint8(11) == 0x20 and uint8(12) == 0x2F
        ) and not (
            // Check for legitimate Visual Studio locations
            (
                uint8(1) == 0x43 and uint8(2) == 0x3A and uint8(3) == 0x5C and uint8(4) == 0x50 and uint8(5) == 0x72 and uint8(6) == 0x6F and uint8(7) == 0x67 and uint8(8) == 0x72 and
                uint8(9) == 0x61 and uint8(10) == 0x6D and uint8(11) == 0x20 and uint8(12) == 0x46 and uint8(13) == 0x69 and uint8(14) == 0x6C and uint8(15) == 0x65 and uint8(16) == 0x73 and
                uint8(17) == 0x5C and uint8(18) == 0x4D and uint8(19) == 0x69 and uint8(20) == 0x63 and uint8(21) == 0x72 and uint8(22) == 0x6F and uint8(23) == 0x73 and uint8(24) == 0x6F and
                uint8(25) == 0x66 and uint8(26) == 0x74 and uint8(27) == 0x20 and uint8(28) == 0x56 and uint8(29) == 0x69 and uint8(30) == 0x73 and uint8(31) == 0x75 and uint8(32) == 0x61
            ) or (
                uint8(1) == 0x43 and uint8(2) == 0x3A and uint8(3) == 0x5C and uint8(4) == 0x50 and uint8(5) == 0x72 and uint8(6) == 0x6F and uint8(7) == 0x67 and uint8(8) == 0x72 and
                uint8(9) == 0x61 and uint8(10) == 0x6D and uint8(11) == 0x20 and uint8(12) == 0x46 and uint8(13) == 0x69 and uint8(14) == 0x6C and uint8(15) == 0x65 and uint8(16) == 0x73 and
                uint8(17) == 0x20 and uint8(18) == 0x28 and uint8(19) == 0x78 and uint8(20) == 0x38 and uint8(21) == 0x36 and uint8(22) == 0x29 and uint8(23) == 0x5C
            )
        )
}
