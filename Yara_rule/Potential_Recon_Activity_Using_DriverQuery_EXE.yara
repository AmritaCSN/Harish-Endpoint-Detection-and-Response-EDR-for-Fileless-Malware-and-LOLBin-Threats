rule Potential_Recon_Activity_Using_DriverQuery_EXE {
    meta:
        description = "Detects usage of the driverquery utility to perform reconnaissance on installed drivers"
        author = "Nasreddine Bencherchali (Nextron Systems)"
        date = "2023/01/19"
        modified = "2023/09/29"
        status = "experimental"
        tags = "attack.discovery, level.high"
    strings:
        $driverquery_exe = "driverquery.exe" wide
        $drvqry_exe = "drvqry.exe" wide
        $cscript_parent = { 5C 63 73 63 72 69 70 74 2E 65 78 65 } // \cscript.exe
        $mshta_parent = { 5C 6D 73 68 74 61 2E 65 78 65 } // \mshta.exe
        $regsvr32_parent = { 5C 72 65 67 73 76 72 33 32 2E 65 78 65 } // \regsvr32.exe
        $rundll32_parent = { 5C 72 75 6E 64 6C 6C 33 32 2E 65 78 65 } // \rundll32.exe
        $wscript_parent = { 5C 77 73 63 72 69 70 74 2E 65 78 65 } // \wscript.exe
        $suspicious_paths = { 5C 41 70 70 44 61 74 61 5C 4C 6F 63 61 6C 5C } // \AppData\Local\
                            $suspicious_paths2 = { 5C 55 73 65 72 73 5C 50 75 62 6C 69 63 5C } // \Users\Public\
                            $suspicious_paths3 = { 5C 57 69 6E 64 6F 77 73 5C 54 65 6D 70 5C } // \Windows\Temp\
    condition:
        (uint16(0) == 0x5A4D) and
        ($driverquery_exe at 0 or $drvqry_exe at 0) and
        any of ($cscript_parent, $mshta_parent, $regsvr32_parent, $rundll32_parent, $wscript_parent) and
        any of ($suspicious_paths, $suspicious_paths2, $suspicious_paths3)
}
