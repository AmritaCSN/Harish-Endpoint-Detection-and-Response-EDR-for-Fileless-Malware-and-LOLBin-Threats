rule IIS_Native_Code_Module_Command_Line_Installation {
    meta:
        description = "Detects suspicious IIS native-code module installations via command line"
        author = "Florian Roth (Nextron Systems)"
        date = "2019/12/11"
        modified = "2023/01/22"
        status = "test"
        tags = "attack.persistence, attack.t1505.003"
        references = "https://researchcenter.paloaltonetworks.com/2018/01/unit42-oilrig-uses-rgdoor-iis-backdoor-targets-middle-east/, https://www.microsoft.com/security/blog/2022/07/26/malicious-iis-extensions-quietly-open-persistent-backdoors-into-servers/"
    strings:
        $iis_module_cli = /.*appcmd\.exe.*install.*module.*(-name:|\/name:).*/ nocase
        $iissetup_exe = "C:\\Windows\\System32\\inetsrv\\iissetup.exe"
    condition:
        $iis_module_cli and not $iissetup_exe
}
