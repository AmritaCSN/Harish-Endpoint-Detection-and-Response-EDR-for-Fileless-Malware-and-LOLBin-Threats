rule Lolbin_Ssh_EXE_Use_As_Proxy {
    meta:
        description = "Detect usage of the ssh.exe binary as a proxy to launch other programs"
        reference = "https://lolbas-project.github.io/lolbas/Binaries/Ssh/"
        author = "frack113, Nasreddine Bencherchali"
        date = "2022/12/29"
        level = "medium"
    strings:
        $ssh_exe = "ssh.exe" nocase
    condition:
        $ssh_exe at 0 and (
            // Check if ssh.exe is used as a proxy by looking for specific command line flags
            (
                // Parent command line: '"C:\Windows\System32\OpenSSH\sshd.exe" -R'
                uint8(1) == 0x22 and uint8(2) == 0x43 and uint8(3) == 0x3A and uint8(4) == 0x5C and
                uint8(5) == 0x57 and uint8(6) == 0x69 and uint8(7) == 0x6E and uint8(8) == 0x64 and uint8(9) == 0x6F and
                uint8(10) == 0x77 and uint8(11) == 0x73 and uint8(12) == 0x5C and uint8(13) == 0x53 and uint8(14) == 0x79 and
                uint8(15) == 0x73 and uint8(16) == 0x74 and uint8(17) == 0x65 and uint8(18) == 0x6D and uint8(19) == 0x33 and
                uint8(20) == 0x32 and uint8(21) == 0x5C and uint8(22) == 0x4F and uint8(23) == 0x70 and uint8(24) == 0x65 and
                uint8(25) == 0x6E and uint8(26) == 0x53 and uint8(27) == 0x53 and uint8(28) == 0x48 and uint8(29) == 0x5C and
                uint8(30) == 0x73 and uint8(31) == 0x73 and uint8(32) == 0x68 and uint8(33) == 0x64 and uint8(34) == 0x2E and
                uint8(35) == 0x65 and uint8(36) == 0x78 and uint8(37) == 0x65 and uint8(38) == 0x22 and uint8(39) == 0x20 and
                uint8(40) == 0x2D and uint8(41) == 0x52
            ) or (
                // Check if ssh.exe command line contains specific flags indicating proxy usage
                uint8(1) == 0x50 and uint8(2) == 0x72 and uint8(3) == 0x6F and uint8(4) == 0x78 and uint8(5) == 0x79 and
                uint8(6) == 0x43 and uint8(7) == 0x6F and uint8(8) == 0x6D and uint8(9) == 0x6D and uint8(10) == 0x61 and
                uint8(11) == 0x6E and uint8(12) == 0x64 and uint8(13) == 0x3D and uint8(14) == 0x27
            ) or (
                uint8(1) == 0x4C and uint8(2) == 0x6F and uint8(3) == 0x63 and uint8(4) == 0x61 and uint8(5) == 0x6C and
                uint8(6) == 0x43 and uint8(7) == 0x6F and uint8(8) == 0x6D and uint8(9) == 0x6D and uint8(10) == 0x61 and
                uint8(11) == 0x6E and uint8(12) == 0x64 and uint8(13) == 0x3D and uint8(14) == 0x27
            )
        )
}
