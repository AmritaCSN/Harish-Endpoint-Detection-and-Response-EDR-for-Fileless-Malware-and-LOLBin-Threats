rule HackTool_Empire_PowerShell_Launch_Parameters {
    meta:
        description = "Detects suspicious PowerShell command line parameters used in Empire"
        author = "Florian Roth (Nextron Systems)"
        date = "2019/04/20"
        modified = "2023/02/21"
        status = "test"
        tags = "attack.execution, attack.t1059.001"
        references = "https://github.com/EmpireProject/Empire/blob/c2ba61ca8d2031dad0cfc1d5770ba723e8b710db/lib/common/helpers.py#L165, https://github.com/EmpireProject/Empire/blob/e37fb2eef8ff8f5a0a689f1589f424906fe13055/lib/modules/powershell/persistence/powerbreach/deaduser.py#L191, https://github.com/EmpireProject/Empire/blob/e37fb2eef8ff8f5a0a689f1589f424906fe13055/lib/modules/powershell/persistence/powerbreach/resolver.py#L178, https://github.com/EmpireProject/Empire/blob/e37fb2eef8ff8f5a0a689f1589f424906fe13055/data/module_source/privesc/Invoke-EventVwrBypass.ps1#L64"
    strings:
        $empire_parameters = / -NoP -sta -NonI -W Hidden -Enc | -noP -sta -w 1 -enc | -NoP -NonI -W Hidden -enc | -noP -sta -w 1 -enc| -enc  SQB| -nop -exec bypass -EncodedCommand /
    condition:
        $empire_parameters
}
