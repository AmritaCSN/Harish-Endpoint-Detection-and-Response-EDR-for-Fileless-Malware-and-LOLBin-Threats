rule HackTool_Impacket_Lateral_Movement {
    meta:
        description = "Detects wmiexec/dcomexec/atexec/smbexec from Impacket framework"
        author = "Ecco, oscd.community, Jonhnathan Ribeiro, Tim Rauch"
        date = "2019/09/03"
        modified = "2023/02/21"
        status = "stable"
        tags = "attack.execution, attack.t1047, attack.lateral_movement, attack.t1021.003"
        references = "https://github.com/SecureAuthCorp/impacket/blob/8b1a99f7c715702eafe3f24851817bb64721b156/examples/wmiexec.py, https://github.com/SecureAuthCorp/impacket/blob/8b1a99f7c715702eafe3f24851817bb64721b156/examples/atexec.py, https://github.com/SecureAuthCorp/impacket/blob/8b1a99f7c715702eafe3f24851817bb64721b156/examples/smbexec.py, https://github.com/SecureAuthCorp/impacket/blob/8b1a99f7c715702eafe3f24851817bb64721b156/examples/dcomexec.py, https://www.elastic.co/guide/en/security/current/suspicious-cmd-execution-via-wmi.html"
    strings:
        $wmiexec = /cmd.exe \/Q \/c .* \\[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\\.* 2>&1/
        $dcomexec_mmc = /"C:\\Windows\\System32\\cmd.exe" \/Q \/c .* \\[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\\.* 2>&1/
        $dcomexec_shellbrowser = /"C:\\Windows\\System32\\cmd.exe" \/Q \/c .* \\[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\\.* 2>&1/
        $smbexec = /C:\\Windows\\system32\\cmd.exe \/Q \/c .* \\[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\\.* & del C:\\Windows\\TEMP\\execute.bat/
        $atexec_svchost = /svchost.exe -k netsvcs.*cmd.exe \/C.*Windows\\Temp\\.* 2>&1/
        $atexec_taskeng = /taskeng.exe.*cmd.exe \/C.*Windows\\Temp\\.* 2>&1/
    condition:
        1 of ($wmiexec, $dcomexec_mmc, $dcomexec_shellbrowser, $smbexec, $atexec_svchost, $atexec_taskeng)
}
