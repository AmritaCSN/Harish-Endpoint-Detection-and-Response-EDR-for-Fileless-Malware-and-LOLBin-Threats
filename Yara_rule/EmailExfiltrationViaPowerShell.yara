rule EmailExfiltrationViaPowerShell {
    meta:
        description = "Detects email exfiltration via PowerShell cmdlets"
        author = "Nasreddine Bencherchali (Nextron Systems), Azure-Sentinel (idea)"
        date = "2022/09/09"
        reference = "https://www.microsoft.com/security/blog/2022/09/07/profiling-dev-0270-phosphorus-ransomware-operations/, https://github.com/Azure/Azure-Sentinel/blob/7e6aa438e254d468feec061618a7877aa528ee9f/Hunting%20Queries/Microsoft%20365%20Defender/Ransomware/DEV-0270/Email%20data%20exfiltration%20via%20PowerShell.yaml"
        tags = "attack.exfiltration"
    strings:
        $powershell_processes = /powershell\.exe|pwsh\.exe/ nocase
        $cmdlets_pattern = /Add-PSSnapin.*Get-Recipient.*-ExpandProperty.*EmailAddresses.*SmtpAddress.*-hidetableheaders/i
    condition:
        all of ($powershell_processes, $cmdlets_pattern)
}
