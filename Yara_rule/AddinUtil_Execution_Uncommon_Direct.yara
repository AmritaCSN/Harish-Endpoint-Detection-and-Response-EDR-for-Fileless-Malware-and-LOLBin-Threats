rule AddinUtil_Execution_Uncommon_Directory
{
    meta:
        description = "Detects execution of Add-In deployment cache updating utility (AddInUtil.exe) from a non-standard directory"
        id = "6120ac2a-a34b-42c0-a9bd-1fb9f459f348"
        status = "experimental"
        references = "https://www.blue-prints.blog/content/blog/posts/lolbin/addinutil-lolbas.html"
        author = "Michael McKinley (@McKinleyMike), Tony Latteri (@TheLatteri)"
        date = "2023/09/18"
        tags = "attack.defense_evasion, attack.t1218"
        level = "medium"
    
    strings:
        $img_endswith_addinutil = "addinutil.exe" nocase
        $original_filename = "AddInUtil.exe" nocase
        $legit_location_1 = "C:\\Windows\\Microsoft.NET\\Framework\\"
        $legit_location_2 = "C:\\Windows\\Microsoft.NET\\Framework64\\"
        $legit_location_3 = "C:\\Windows\\WinSxS\\"

    condition:
        $img_endswith_addinutil and
        $original_filename and
        not (
            $legit_location_1  or
            $legit_location_2  or
            $legit_location_3 
        )
}
