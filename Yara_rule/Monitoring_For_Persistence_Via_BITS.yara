rule MonitoringForPersistenceViaBITS {
    meta:
        title = "Monitoring For Persistence Via BITS"
        id = "b9cbbc17-d00d-4e3d-a827-b06d03d2380d"
        status = "test"
        description = "BITS can be abused for creating a backdoor within the system and for persistence by scheduling the download of malware/additional binaries and executing them after being downloaded."
        references = "https://www.fireeye.com/blog/threat-research/2020/10/kegtap-and-singlemalt-with-a-ransomware-chaser.html, http://0xthem.blogspot.com/2014/03/t-emporal-persistence-with-and-schtasks.html, https://isc.sans.edu/diary/Wipe+the+drive+Stealthy+Malware+Persistence+Mechanism+-+Part+1/15394"
        author = "Sreeman"
        date = "2020/10/29"
        tags = "attack.defense_evasion, attack.t1197"
    strings:
        $bitsadminSetNotifyCmdLine = "bitsadmin /SetNotifyCmdLine" wide ascii
        $bitsadminAddfile = "bitsadmin /Addfile" wide ascii
        $comSpec = "%COMSPEC%" wide ascii
        $cmdExe = "cmd.exe" wide ascii
        $regsvr32Exe = "regsvr32.exe" wide ascii
        $http = "http:" wide ascii
        $https = "https:" wide ascii
        $ftp = "ftp:" wide ascii
        $ftps = "ftps:" wide ascii
    condition:
        (any of ($bitsadminSetNotifyCmdLine) and all of ($comSpec, $cmdExe, $regsvr32Exe)) or
        (any of ($bitsadminAddfile) and any of ($http, $https, $ftp, $ftps))
}
