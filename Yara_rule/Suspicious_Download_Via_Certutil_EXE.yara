rule Suspicious_Download_Via_Certutil_EXE {
    meta:
        description = "Detects the execution of certutil with certain flags that allow the utility to download files."
        author = "Florian Roth (Nextron Systems), Jonhnathan Ribeiro, oscd.community, Nasreddine Bencherchali (Nextron Systems)"
        date = "2023/02/15"
        reference = "https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil"
        reference = "https://forensicitguy.github.io/agenttesla-vba-certutil-download/"
        reference = "https://news.sophos.com/en-us/2021/04/13/compromised-exchange-server-hosting-cryptojacker-targeting-other-exchange-servers/"
        reference = "https://twitter.com/egre55/status/1087685529016193025"
        reference = "https://lolbas-project.github.io/lolbas/Binaries/Certutil/"
        status = "test"
        tags = "attack.defense_evasion, attack.t1027, level.medium"
    strings:
        $certutilPath = "\\certutil.exe"
        $urlcacheFlag = "urlcache "
        $verifyctlFlag = "verifyctl "
        $httpFlag = "http"
    condition:
        any of them
}
