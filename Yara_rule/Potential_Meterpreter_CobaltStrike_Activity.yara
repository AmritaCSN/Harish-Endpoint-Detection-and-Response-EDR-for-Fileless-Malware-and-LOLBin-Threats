rule Potential_Meterpreter_CobaltStrike_Activity {
    meta:
        description = "Detects the use of getsystem Meterpreter/Cobalt Strike command by detecting a specific service starting"
        author = "Teymur Kheirkhabarov, Ecco, Florian Roth"
        date = "2019/10/26"
        modified = "2023/02/05"
        status = "test"
        tags = "attack.privilege_escalation, attack.t1134.001, attack.t1134.002"
        references = "https://speakerdeck.com/heirhabarov/hunting-for-privilege-escalation-in-windows-environment, https://blog.cobaltstrike.com/2014/04/02/what-happens-when-i-type-getsystem/"
    strings:
        $potential_meterpreter_cobaltstrike_1 = /.*\\services\.exe$/
        $potential_meterpreter_cobaltstrike_2 = /.*\/c.*echo.*\\\.\\pipe\\/
        $potential_meterpreter_cobaltstrike_3 = /.*rundll32.*\.dll,a.*\/p:/
        $potential_meterpreter_cobaltstrike_4 = /.*MpCmdRun.*/
    condition:
        $potential_meterpreter_cobaltstrike_1 and
        ($potential_meterpreter_cobaltstrike_2 or $potential_meterpreter_cobaltstrike_3) and
        not $potential_meterpreter_cobaltstrike_4
}
