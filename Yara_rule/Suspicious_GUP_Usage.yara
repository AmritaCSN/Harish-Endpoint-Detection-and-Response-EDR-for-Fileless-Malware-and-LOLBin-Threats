rule Suspicious_GUP_Usage {
    meta:
        description = "Detects execution of the Notepad++ updater in a suspicious directory, which is often used in DLL side-loading attacks"
        author = "Florian Roth (Nextron Systems)"
        date = "2019/02/06"
        modified = "2022/08/13"
        status = "test"
        tags = "attack.defense_evasion, attack.t1574.002, level.high"
        references = "https://www.fireeye.com/blog/threat-research/2018/09/apt10-targeting-japanese-corporations-using-updated-ttps.html"
    strings:
        $gup_executable = "GUP.exe" wide
        $program_files_path_32 = "\\Program Files\\Notepad++\\updater\\GUP.exe" wide
        $program_files_path_64 = "\\Program Files (x86)\\Notepad++\\updater\\GUP.exe" wide
        $user_path_32 = "\\AppData\\Local\\Notepad++\\updater\\GUP.exe" wide
        $user_path_64 = "\\AppData\\Roaming\\Notepad++\\updater\\GUP.exe" wide
    condition:
        uint16(0) == 0x5A4D and
        $gup_executable at 1 and
        (
            $program_files_path_32 at entrypoint or
            $program_files_path_64 at entrypoint or
            $user_path_32 at entrypoint or
            $user_path_64 at entrypoint
        )
}
