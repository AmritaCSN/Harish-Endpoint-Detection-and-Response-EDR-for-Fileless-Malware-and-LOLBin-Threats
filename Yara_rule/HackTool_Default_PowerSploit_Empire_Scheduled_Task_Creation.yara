rule HackTool_Default_PowerSploit_Empire_Scheduled_Task_Creation {
    meta:
        description = "Detects the creation of a schtask via PowerSploit or Empire Default Configuration."
        author = "Markus Neis, @Karneades"
        date = "2018/03/06"
        modified = "2023/03/03"
        status = "test"
        tags = "attack.execution, attack.persistence, attack.privilege_escalation, attack.s0111, attack.g0022, attack.g0060, car.2013-08-001, attack.t1053.005, attack.t1059.001"
        references = "https://github.com/0xdeadbeefJERKY/PowerSploit/blob/8690399ef70d2cad10213575ac67e8fa90ddf7c3/Persistence/Persistence.psm1, https://github.com/EmpireProject/Empire/blob/08cbd274bef78243d7a8ed6443b8364acd1fc48b/lib/modules/powershell/persistence/userland/schtasks.py"
    strings:
        $hacktool_powershell = /.*\\powershell\.exe$/
        $hacktool_pwsh = /.*\\pwsh\.exe$/
        $hacktool_schtasks = /.*\\schtasks\.exe$/
        $hacktool_create_task = /.*\/Create.*powershell\.exe -NonI.*\/TN Updater \/TR/
        $hacktool_sc_options = /.*\/SC (ONLOGON|DAILY|ONIDLE|HOURLY) \/ST/
    condition:
        $hacktool_powershell or $hacktool_pwsh and
        $hacktool_schtasks and
        $hacktool_create_task and
        $hacktool_sc_options
}
