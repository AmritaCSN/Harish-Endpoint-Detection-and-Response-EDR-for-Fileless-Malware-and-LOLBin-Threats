rule Potential_MsiExec_Masquerading {
    meta:
        description = "Detects the execution of msiexec.exe from an uncommon directory"
        reference = "https://twitter.com/200_okay_/status/1194765831911215104"
        author = "Florian Roth (Nextron Systems)"
        date = "2019/11/14"
        modified = "2023/02/21"
        tags = "attack.defense_evasion, attack.t1036.005"
        status = "test"
        level = "high"

    strings:
        $msiexec_process = "msiexec.exe" wide ascii
        $filter_common_locations = /C:\\Windows\\System32\\/ wide ascii
        $filter_sxs_locations = /C:\\Windows\\WinSxS\\/ wide ascii

    condition:
        ($msiexec_process at 0 and not ($filter_common_locations or $filter_sxs_locations))
}
