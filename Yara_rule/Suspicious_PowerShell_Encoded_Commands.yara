rule Suspicious_PowerShell_Encoded_Commands {
    meta:
        description = "Detects PowerShell command line patterns with encoded commands"
        author = "Florian Roth (Nextron Systems)"
        date = "2022/05/24"
        modified = "2023/01/05"
        reference = "https://app.any.run/tasks/b9040c63-c140-479b-ad59-f1bb56ce7a97/"
        level = "high"
    
    strings:
        $powershell_exe = /powershell\.exe|pwsh\.exe|PowerShell\.Exe|pwsh\.dll/
        $encoded_flags = / -e | -en | -enc | -enco/
        $encoded_strings = / JAB| SUVYI| SQBFAFgA| aWV4I| IAB| PAA| aQBlAHgA/
        $gcworker_path1 = /C:\\Packages\\Plugins\\Microsoft\.GuestConfiguration\.ConfigurationforWindows\\/
        $gcworker_path2 = /\\gc_worker\.exe/

    condition:
        all of ($powershell_exe, $encoded_flags, $encoded_strings) and
        (all of them or 1 of ($gcworker_path1, $gcworker_path2))
}
