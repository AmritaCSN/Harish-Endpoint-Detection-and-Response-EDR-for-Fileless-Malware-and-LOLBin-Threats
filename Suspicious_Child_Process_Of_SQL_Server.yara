rule Suspicious_Child_Process_Of_SQL_Server {
    meta:
        description = "Detects suspicious child processes of the SQLServer process. This could indicate potential RCE or SQL Injection."
        references = "Internal Research"
        author = "FPT.EagleEye Team, wagga"
        date = "2020/12/11"
        modified = "2023/05/04"
        tags = "attack.t1505.003, attack.t1190, attack.initial_access, attack.persistence, attack.privilege_escalation"
        status = "experimental"
        level = "high"

    strings:
        $sql_server_process = "\\sqlservr.exe" wide ascii
        $suspicious_child_processes = /\\bash.exe|\\bitsadmin.exe|\\cmd.exe|\\netstat.exe|\\nltest.exe|\\ping.exe|\\powershell.exe|\\pwsh.exe|\\regsvr32.exe|\\rundll32.exe|\\sh.exe|\\systeminfo.exe|\\tasklist.exe|\\wsl.exe/ wide ascii
        $datev_sql_server_process = "C:\\Program Files\\Microsoft SQL Server\\DATEV_DBENGINE\\MSSQL\\Binn\\sqlservr.exe" wide ascii
        $cmd_exe_process = "\"C:\\Windows\\system32\\cmd.exe\" " wide ascii

    condition:
        $sql_server_process at 0 and $suspicious_child_processes and not ($datev_sql_server_process at 0 and $cmd_exe_process at 0)
}
