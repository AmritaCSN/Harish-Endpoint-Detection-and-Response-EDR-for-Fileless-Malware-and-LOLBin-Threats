rule Potentially_Suspicious_PowerShell_Child_Processes {
    meta:
        description = "Detects potentially suspicious child processes spawned by PowerShell"
        author = "Florian Roth (Nextron Systems), Tim Shelton"
        date = "2022/04/26"
        modified = "2023/05/30"
        references = "https://twitter.com/ankit_anubhav/status/1518835408502620162"
        tags = "attack.execution, attack.t1059.001"
        level = "high"

    strings:
        $powershellProcesses = /\b(powershell_ise\.exe|powershell\.exe|pwsh\.exe)\b/i
        $suspiciousChildProcesses = /\b(bash\.exe|bitsadmin\.exe|certutil\.exe|cscript\.exe|forfiles\.exe|hh\.exe|mshta\.exe|regsvr32\.exe|rundll32\.exe|schtasks\.exe|scrcons\.exe|scriptrunner\.exe|sh\.exe|wmic\.exe|wscript\.exe)\b/i
        $awsWorkspaces = /\b\\Program Files\\Amazon\\WorkspacesConfig\\Scripts\\/i

    condition:
        $powershellProcesses at 0 and $suspiciousChildProcesses at 0 and not $awsWorkspaces
}
