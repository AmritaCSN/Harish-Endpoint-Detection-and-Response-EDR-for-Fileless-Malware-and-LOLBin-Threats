rule PowerShellDownloadPattern {
    meta:
        description = "Detects a PowerShell process that contains download commands in its command line string"
        author = "Florian Roth (Nextron Systems), oscd.community, Jonhnathan Ribeiro"
        date = "2019/01/16"
        reference = "https://blog.redteam.pl/2020/06/black-kingdom-ransomware.html, https://lab52.io/blog/winter-vivern-all-summer/, https://hatching.io/blog/powershell-analysis/"
        tags = "attack.execution, attack.t1059.001"
    strings:
        $powershell_processes = /powershell\.exe|pwsh\.exe|PowerShell\.EXE|pwsh\.dll/ nocase
        $download_pattern1 = /new-object.*net\.webclient\)\..*download/i
        $download_pattern2 = /string\(|file\(/i
    condition:
        all of ($powershell_processes, $download_pattern1, $download_pattern2)
}
