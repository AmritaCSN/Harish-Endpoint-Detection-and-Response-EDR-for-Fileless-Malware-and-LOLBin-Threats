rule Suspicious_PowerShell_Parameter_Substring {
    meta:
        description = "Detects suspicious PowerShell invocation with a parameter substring"
        author = "Florian Roth (Nextron Systems), Daniel Bohannon (idea), Roberto Rodriguez (Fix)"
        date = "2019/01/16"
        modified = "2022/07/14"
        references = "http://www.danielbohannon.com/blog-1/2017/3/12/powershell-execution-argument-obfuscation-how-it-can-make-detection-easier"
        tags = "attack.execution, attack.t1059.001"
        level = "high"

    strings:
        $powershellProcesses = /\b(powershell\.exe|pwsh\.exe)\b/i
        $suspiciousParameters = /\b(-windowstyle h|-windowstyl h|-windowsty h|-windowst h|-windows h|-windo h|-wind h|-win h|-wi h|-win h|-win hi|-win hid|-win hidd|-win hidde|-NoPr|-NoPro|-NoProf|-NoProfi|-NoProfil|-nonin|-nonint|-noninte|-noninter|-nonintera|-noninterac|-noninteract|-noninteracti|-noninteractiv|-ec|-encodedComman|-encodedComma|-encodedComm|-encodedCom|-encodedCo|-encodedC|-encoded|-encode|-encod|-enco|-en|-executionpolic|-executionpoli|-executionpol|-executionpo|-executionp|-execution bypass|-executio bypass|-executi bypass|-execut bypass|-execu bypass|-exec bypass|-exe bypass|-ex bypass|-ep bypass|\/windowstyle h|\/windowstyl h|\/windowsty h|\/windowst h|\/windows h|\/windo h|\/wind h|\/win h|\/wi h|\/win h|\/win hi|\/win hid|\/win hidd|\/win hidde|\/NoPr|\/NoPro|\/NoProf|\/NoProfi|\/NoProfil|\/nonin|\/nonint|\/noninte|\/noninter|\/nonintera|\/noninterac|\/noninteract|\/noninteracti|\/noninteractiv|\/ec|\/encodedComman|\/encodedComma|\/encodedComm|\/encodedCom|\/encodedCo|\/encodedC|\/encoded|\/encode|\/encod|\/enco|\/en|\/executionpolic|\/executionpoli|\/executionpol|\/executionpo|\/executionp|\/execution bypass|\/executio bypass|\/executi bypass|\/execut bypass|\/execu bypass|\/exec bypass|\/exe bypass|\/ex bypass|\/ep bypass)\b/i

    condition:
        $powershellProcesses at 0 and $suspiciousParameters at 0
}
