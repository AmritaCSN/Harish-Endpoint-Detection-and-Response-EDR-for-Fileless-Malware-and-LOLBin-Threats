rule Suspicious_Shells_Spawn_by_Java_Utility_Keytool {
    meta:
        description = "Detects suspicious shell spawn from Java utility keytool process (e.g., adselfservice plus exploitation)"
        author = "Andreas Hunkeler (@Karneades)"
        date = "2021/12/22"
        modified = "2023/01/21"
        status = "test"
        tags = "attack.initial_access, attack.persistence, attack.privilege_escalation"
        references = "https://redcanary.com/blog/intelligence-insights-december-2021, https://www.synacktiv.com/en/publications/how-to-exploit-cve-2021-40539-on-manageengine-adselfservice-plus.html"
    strings:
        $keytool_exe = /\\keytool\.exe/i
        $suspicious_processes = /\\(cmd\.exe|sh\.exe|bash\.exe|powershell\.exe|pwsh\.exe|schtasks\.exe|certutil\.exe|whoami\.exe|bitsadmin\.exe|wscript\.exe|cscript\.exe|scrcons\.exe|regsvr32\.exe|hh\.exe|wmic\.exe|mshta\.exe|rundll32\.exe|forfiles\.exe|scriptrunner\.exe|mftrace\.exe|AppVLP\.exe|systeminfo\.exe|reg\.exe|query\.exe)$/i
    condition:
        $keytool_exe at 0 and $suspicious_processes at 1
}
