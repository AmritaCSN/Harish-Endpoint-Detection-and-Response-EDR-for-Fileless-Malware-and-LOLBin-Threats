rule Uncommon_AddinUtil_CommandLine_Execution
{
    meta:
        description = "Detects uncommon AddinUtil.exe command-line execution"
        id = "4f2cd9b6-4a17-440f-bb2a-687abb65993a"
        status = "experimental"
        references = "https://www.blue-prints.blog/content/blog/posts/lolbin/addinutil-lolbas.html"
        author = "Michael McKinley (@McKinleyMike), Tony Latteri (@TheLatteri)"
        date = "2023/09/18"
        tags = "attack.defense_evasion, attack.t1218"
        level = "medium"
    
    strings:
        $img_endswith_addinutil = "addinutil.exe"
        $filename = "AddInUtil.exe"
        $cmd_contains_addinroot = "-AddInRoot:"
        $cmd_contains_pipelineroot = "-PipelineRoot:"
        $filter_main_addinroot_1 = "-AddInRoot:\"C:\\Program Files (x86)\\Common Files\\Microsoft Shared\\VSTA"
        $filter_main_addinroot_2 = "-AddInRoot:C:\\Program Files (x86)\\Common Files\\Microsoft Shared\\VSTA"
        $filter_main_pipelineroot_1 = "-PipelineRoot:\"C:\\Program Files (x86)\\Common Files\\Microsoft Shared\\VSTA"
        $filter_main_pipelineroot_2 = "-PipelineRoot:C:\\Program Files (x86)\\Common Files\\Microsoft Shared\\VSTA"

    condition:
        $img_endswith_addinutil and
        $filename and
        (
            $cmd_contains_addinroot or
            $cmd_contains_pipelineroot
        ) and not (
            $filter_main_addinroot_1 or
            $filter_main_addinroot_2 or
            $filter_main_pipelineroot_1 or
            $filter_main_pipelineroot_2
        )
}
